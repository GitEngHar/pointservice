name: Keploy Test
on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      [ master ]
jobs:
  keploy-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      # Docker を使うので必須
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3
      # docker compose v2 を明示（ubuntu-latest では大体入ってるが保険）
      - name: Install docker-compose
        run: |
          docker compose version
      # Go の依存整理（任意だが安全）
      - name: Go mod tidy
        run: make tidy
      - name: Build image
        run: docker build --target final -t point-service:1.0 .
      - name: Start MiddleWare
        run: docker compose -f docker-compose.middleware.yml up -d
      - name: Install Keploy
        run: |
          curl --silent --location \
            https://github.com/keploy/keploy/releases/latest/download/keploy_linux_amd64.tar.gz \
            | tar xz -C /tmp
          
          sudo mv /tmp/keploy /usr/local/bin/keploy
          sudo chmod +x /usr/local/bin/keploy
          
          keploy --version
      - name: Keploy Test
        run: |
          keploy test \
            -c "docker run --rm \
                -p 1323:1323 \
                --name point-app \
                --network pointservice_keploy-network \
                -e POINT_MYSQL_HOST=mysql \
                -e POINT_MYSQL_DATABASE=appdb \
                -e POINT_MYSQL_PORT=3306 \
                -e POINT_MYSQL_USER=appuser \
                -e POINT_MYSQL_PASSWORD=apppass \
                -e POINT_MYSQL_MAX_OPEN_CONNECTIONS=2 \
                -e POINT_MYSQL_MAX_IDLE_CONNECTIONS=1 \
                point-service:1.0" \
            --delay 30 \
            --buildDelay 50 \
            --path .
      # 後片付け
      - name: Cleanup
        if: always()
        run: make down || true
